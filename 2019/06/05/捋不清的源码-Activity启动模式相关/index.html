<!DOCTYPE html>
<html lang>
  <head><meta name="generator" content="Hexo 3.8.0">
    
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="description" content="捋不清的源码---Activity启动模式相关">




  <meta name="keywords" content="源码,">





  <link rel="alternate" href="/uuluu.github.io/default" title="LLL_">




  <link rel="shortcut icon" type="image/x-icon" href="/uuluu.github.io/favicon.ico?v=1.1">



<link rel="canonical" href="http://yoursite.com/2019/06/05/捋不清的源码-Activity启动模式相关/">


<meta name="description" content="源码基于Android 8.1  Launcher.java12345678910111213141516171819202122232425public boolean startActivitySafely(View v, Intent intent, ItemInfo item) &amp;#123;    ...    intent.addFlags(Intent.FLAG_ACTIVITY_N">
<meta name="keywords" content="源码">
<meta property="og:type" content="article">
<meta property="og:title" content="捋不清的源码---Activity启动模式相关">
<meta property="og:url" content="http://yoursite.com/2019/06/05/捋不清的源码-Activity启动模式相关/index.html">
<meta property="og:site_name" content="LLL_">
<meta property="og:description" content="源码基于Android 8.1  Launcher.java12345678910111213141516171819202122232425public boolean startActivitySafely(View v, Intent intent, ItemInfo item) &amp;#123;    ...    intent.addFlags(Intent.FLAG_ACTIVITY_N">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-08-02T05:39:14.914Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="捋不清的源码---Activity启动模式相关">
<meta name="twitter:description" content="源码基于Android 8.1  Launcher.java12345678910111213141516171819202122232425public boolean startActivitySafely(View v, Intent intent, ItemInfo item) &amp;#123;    ...    intent.addFlags(Intent.FLAG_ACTIVITY_N">


<link rel="stylesheet" type="text/css" href="/uuluu.github.io/css/style.css?v=1.1">
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> 捋不清的源码---Activity启动模式相关 - LLL_ </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/uuluu.github.io/." class="logo">LLL_</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/uuluu.github.io/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/uuluu.github.io/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          捋不清的源码---Activity启动模式相关
        
      </h1>

      <time class="post-time">
          Jun 05 2019
      </time>
    </header>



    
            <div class="post-content">
            <blockquote>
<p>源码基于Android 8.1</p>
</blockquote>
<h4 id="Launcher-java"><a href="#Launcher-java" class="headerlink" title="Launcher.java"></a>Launcher.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">startActivitySafely</span><span class="params">(View v, Intent intent, ItemInfo item)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Utilities.ATLEAST_MARSHMALLOW</span><br><span class="line">                &amp;&amp; (item <span class="keyword">instanceof</span> ShortcutInfo)</span><br><span class="line">                &amp;&amp; (item.itemType == Favorites.ITEM_TYPE_SHORTCUT</span><br><span class="line">                    || item.itemType == Favorites.ITEM_TYPE_DEEP_SHORTCUT)</span><br><span class="line">                &amp;&amp; !((ShortcutInfo) item).isPromise()) &#123;</span><br><span class="line">            <span class="comment">// Shortcuts need some special checks due to legacy reasons.</span></span><br><span class="line">            startShortcutIntentSafely(intent, optsBundle, item);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (user == <span class="keyword">null</span> || user.equals(Process.myUserHandle())) &#123;</span><br><span class="line">            <span class="comment">// start</span></span><br><span class="line">            startActivity(intent, optsBundle);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LauncherAppsCompat.getInstance(<span class="keyword">this</span>).startActivityForProfile(</span><br><span class="line">                    intent.getComponent(), user, intent.getSourceBounds(), optsBundle);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ActivityNotFoundException|SecurityException e) &#123;</span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>, R.string.activity_not_found, Toast.LENGTH_SHORT).show();</span><br><span class="line">        Log.e(TAG, <span class="string">"Unable to launch. tag="</span> + item + <span class="string">" intent="</span> + intent, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Activity-java"><a href="#Activity-java" class="headerlink" title="Activity.java"></a>Activity.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(@RequiresPermission Intent intent, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">            options = transferSpringboardActivityOptions(options);</span><br><span class="line">            Instrumentation.ActivityResult ar =</span><br><span class="line">                mInstrumentation.execStartActivity(</span><br><span class="line">                    <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</span><br><span class="line">                    intent, requestCode, options);</span><br><span class="line">            <span class="keyword">if</span> (ar != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mMainThread.sendActivityResult(</span><br><span class="line">                    mToken, mEmbeddedID, requestCode, ar.getResultCode(),</span><br><span class="line">                    ar.getResultData());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                </span><br><span class="line">                mStartedActivity = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>主要是调用Instrumentation里面的execStartActivity，就是通过AMS调用到startActivity。</p>
<h4 id="ActivityManagerService-java"><a href="#ActivityManagerService-java" class="headerlink" title="ActivityManagerService.java"></a>ActivityManagerService.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">            Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo,</span><br><span class="line">                resultWho, requestCode, startFlags, profilerInfo, bOptions,</span><br><span class="line">                UserHandle.getCallingUserId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityAsUser</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">            Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        enforceNotIsolatedCaller(<span class="string">"startActivity"</span>);</span><br><span class="line">        userId = mUserController.handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(),</span><br><span class="line">                userId, <span class="keyword">false</span>, ALLOW_FULL_ONLY, <span class="string">"startActivity"</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">//caller不为空，callingUid为-1，</span></span><br><span class="line">        <span class="keyword">return</span> mActivityStarter.startActivityMayWait(caller, -<span class="number">1</span>, callingPackage, intent,</span><br><span class="line">                resolvedType, <span class="keyword">null</span>, <span class="keyword">null</span>, resultTo, resultWho, requestCode, startFlags,</span><br><span class="line">                profilerInfo, <span class="keyword">null</span>, <span class="keyword">null</span>, bOptions, <span class="keyword">false</span>, userId, <span class="keyword">null</span>, <span class="string">"startActivityAsUser"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="ActivityStarter-java"><a href="#ActivityStarter-java" class="headerlink" title="ActivityStarter.java"></a>ActivityStarter.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityMayWait</span><span class="params">(IApplicationThread caller, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">            String callingPackage, Intent intent, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">            IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">            ProfilerInfo profilerInfo, WaitResult outResult,</span></span></span><br><span class="line"><span class="function"><span class="params">            Configuration globalConfig, Bundle bOptions, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">            TaskRecord inTask, String reason)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> componentSpecified = intent.getComponent() != <span class="keyword">null</span>;</span><br><span class="line">    intent = <span class="keyword">new</span> Intent(intent);</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    ActivityInfo aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags, profilerInfo);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">int</span> res = startActivityLocked(caller, intent, ephemeralIntent, resolvedType,</span><br><span class="line">                    aInfo, rInfo, voiceSession, voiceInteractor,</span><br><span class="line">                    resultTo, resultWho, requestCode, callingPid,</span><br><span class="line">                    callingUid, callingPackage, realCallingPid, realCallingUid, startFlags,</span><br><span class="line">                    options, ignoreTargetSecurity, componentSpecified, outRecord, inTask,</span><br><span class="line">                    reason);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-----------</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">startActivityLocked</span><span class="params">(IApplicationThread caller, Intent intent, Intent ephemeralIntent,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">        String callingPackage, <span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityOptions options, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityRecord[] outActivity, TaskRecord inTask, String reason)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    mLastStartActivityResult = startActivity(caller, intent, ephemeralIntent, resolvedType,</span><br><span class="line">            aInfo, rInfo, voiceSession, voiceInteractor, resultTo, resultWho, requestCode,</span><br><span class="line">            callingPid, callingUid, callingPackage, realCallingPid, realCallingUid, startFlags,</span><br><span class="line">            options, ignoreTargetSecurity, componentSpecified, mLastStartActivityRecord,</span><br><span class="line">            inTask);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, Intent intent, Intent ephemeralIntent,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">        String callingPackage, <span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityOptions options, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityRecord[] outActivity, TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//如果启动的是HomeActivity，那么此时caller是为null的，callingUid依旧为0</span></span><br><span class="line">    <span class="comment">//正常启动时不会为null的</span></span><br><span class="line">    <span class="keyword">if</span> (caller != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//获取启动目标Activity的源Activity线程的ProcessRecord</span></span><br><span class="line">        callerApp = mService.getRecordForAppLocked(caller);</span><br><span class="line">        <span class="keyword">if</span> (callerApp != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//获得pid和uid</span></span><br><span class="line">            callingPid = callerApp.pid;</span><br><span class="line">            callingUid = callerApp.info.uid;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            err = ActivityManager.START_PERMISSION_DENIED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    ...</span><br><span class="line">    ActivityRecord sourceRecord = <span class="keyword">null</span>;</span><br><span class="line">    ActivityRecord resultRecord = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//启动HomeActivity的时候resultTo为空，所以sourceRecord也会是null</span></span><br><span class="line">    <span class="comment">//此时该值为前面传入的token</span></span><br><span class="line">    <span class="keyword">if</span> (resultTo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//通过这个token去遍历stack里面获取ActivityRecord</span></span><br><span class="line">        sourceRecord = mSupervisor.isInAnyStackLocked(resultTo);</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//正常startActivity过来的requestCode为-1</span></span><br><span class="line">            <span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span> &amp;&amp; !sourceRecord.finishing) &#123;</span><br><span class="line">                resultRecord = sourceRecord;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//创建ActivityRecord</span></span><br><span class="line">    ActivityRecord r = <span class="keyword">new</span> ActivityRecord(mService, callerApp, callingPid, callingUid,</span><br><span class="line">                callingPackage, intent, resolvedType, aInfo, mService.getGlobalConfiguration(),</span><br><span class="line">                resultRecord, resultWho, requestCode, componentSpecified, voiceSession != <span class="keyword">null</span>,</span><br><span class="line">                mSupervisor, options, sourceRecord);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> startActivity(r, sourceRecord, voiceSession, voiceInteractor, startFlags, <span class="keyword">true</span>,</span><br><span class="line">                options, inTask, outActivity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, ActivityOptions options, TaskRecord inTask,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityRecord[] outActivity)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    result = startActivityUnchecked(r, sourceRecord, voiceSession, voiceInteractor,</span><br><span class="line">                startFlags, doResume, options, inTask, outActivity);</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivityUnchecked</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, ActivityOptions options, TaskRecord inTask,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityRecord[] outActivity)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//初始化配置，mStartActivity、mLaunchMode等</span></span><br><span class="line">        setInitialState(r, options, inTask, doResume, startFlags, sourceRecord, voiceSession,</span><br><span class="line">                voiceInteractor);</span><br><span class="line">        <span class="comment">//计算mLaunchFlags，具体可以看标记1</span></span><br><span class="line">        computeLaunchingTaskFlags();</span><br><span class="line">        <span class="comment">//计算源Activity所在的Stack</span></span><br><span class="line">        computeSourceStack();</span><br><span class="line">        <span class="comment">//将mLaunchFlags设置给Intent</span></span><br><span class="line">        mIntent.setFlags(mLaunchFlags);</span><br><span class="line">        <span class="comment">//寻找是否可重用的Task，返回栈顶的ActivityRecord，标记2</span></span><br><span class="line">        ActivityRecord reusedActivity = getReusableIntentActivity();</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//根据getReusableIntentActivity方法判断，Standard和SingleTop的启动模式</span></span><br><span class="line">        <span class="comment">//是不会到这个判断里面的</span></span><br><span class="line">        <span class="keyword">if</span> (reusedActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">//将目标Activity的Task设置为重用的Task</span></span><br><span class="line">            <span class="keyword">if</span> (mStartActivity.getTask() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mStartActivity.setTask(reusedActivity.getTask());</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span> (reusedActivity.getTask().intent == <span class="keyword">null</span>) &#123;</span><br><span class="line">                reusedActivity.getTask().setIntent(mStartActivity);</span><br><span class="line">            &#125;</span><br><span class="line">          </span><br><span class="line">            <span class="comment">//如果启动模式是SingleInstance、SingleTask或者设置了FLAG_ACTIVITY_CLEAR_TOP</span></span><br><span class="line">            <span class="keyword">if</span> ((mLaunchFlags &amp; FLAG_ACTIVITY_CLEAR_TOP) != <span class="number">0</span></span><br><span class="line">                    || isDocumentLaunchesIntoExisting(mLaunchFlags)</span><br><span class="line">                    || mLaunchSingleInstance || mLaunchSingleTask) &#123;</span><br><span class="line">                <span class="comment">//获取重用的Task</span></span><br><span class="line">                <span class="keyword">final</span> TaskRecord task = reusedActivity.getTask();</span><br><span class="line">                <span class="comment">//遍历该Task，寻找是否存在一个Activity等于目标Activity</span></span><br><span class="line">                <span class="comment">//存在则将该Activity上面的所有Activity都finish掉</span></span><br><span class="line">                <span class="comment">//如果找到的Activity是标准模式启动的,则把找到的Activity也finish了，返回null</span></span><br><span class="line">                <span class="comment">//不然就返回该找到的Activity</span></span><br><span class="line">                <span class="comment">//该Task内不存在目标Activity，也返回null </span></span><br><span class="line">                <span class="keyword">final</span> ActivityRecord top = task.performClearTaskForReuseLocked(mStartActivity,</span><br><span class="line">                        mLaunchFlags);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (reusedActivity.getTask() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    reusedActivity.setTask(task);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            	<span class="comment">//这边主要是判断了不为null的情况，下面setTaskFromIntentActivity方法内</span></span><br><span class="line">            	<span class="comment">//会判断top为null的情况处理</span></span><br><span class="line">                <span class="keyword">if</span> (top != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (top.frontOfTask) &#123;</span><br><span class="line">                        top.getTask().setIntent(mStartActivity);</span><br><span class="line">                    &#125;</span><br><span class="line">                  	<span class="comment">//会一直调用到onNewIntent</span></span><br><span class="line">                    deliverNewIntent(top);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">//将重用的Task移到ActivityStack前台</span></span><br><span class="line">            reusedActivity = setTargetStackAndMoveToFrontIfNeeded(reusedActivity);</span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">//标记3</span></span><br><span class="line">            setTaskFromIntentActivity(reusedActivity);</span><br><span class="line">            <span class="keyword">if</span> (!mAddingToTask &amp;&amp; mReuseTask == <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="comment">//表示可以复用Activity，并且Task也没有被清空</span></span><br><span class="line">                resumeTargetStackIfNeeded();</span><br><span class="line">                <span class="keyword">if</span> (outActivity != <span class="keyword">null</span> &amp;&amp; outActivity.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    outActivity[<span class="number">0</span>] = reusedActivity;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> START_TASK_TO_FRONT;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//顶部的Activity和目标Activity是不是一样的</span></span><br><span class="line">        <span class="keyword">final</span> ActivityStack topStack = mSupervisor.mFocusedStack;</span><br><span class="line">        <span class="keyword">final</span> ActivityRecord topFocused = topStack.topActivity();</span><br><span class="line">        <span class="keyword">final</span> ActivityRecord top = topStack.topRunningNonDelayedActivityLocked(mNotTop);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> dontStart = top != <span class="keyword">null</span> &amp;&amp; mStartActivity.resultTo == <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; top.realActivity.equals(mStartActivity.realActivity)</span><br><span class="line">                &amp;&amp; top.userId == mStartActivity.userId</span><br><span class="line">                &amp;&amp; top.app != <span class="keyword">null</span> &amp;&amp; top.app.thread != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; ((mLaunchFlags &amp; FLAG_ACTIVITY_SINGLE_TOP) != <span class="number">0</span></span><br><span class="line">                || mLaunchSingleTop || mLaunchSingleTask);</span><br><span class="line">  		<span class="keyword">if</span> (dontStart) &#123;</span><br><span class="line">        		topStack.mLastPausedActivity = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (mDoResume) &#123;</span><br><span class="line">                mSupervisor.resumeFocusedStackTopActivityLocked();</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">            deliverNewIntent(top);</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> START_DELIVERED_TO_TOP;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//下面判断是在没有找到复用的Task的情况下或者是在上面没有处理好的，比如top == null的时候</span></span><br><span class="line">        <span class="comment">//指定了FLAG_ACTIVITY_NEW_TASK</span></span><br><span class="line">        <span class="keyword">if</span> (mStartActivity.resultTo == <span class="keyword">null</span> &amp;&amp; mInTask == <span class="keyword">null</span> &amp;&amp; !mAddingToTask</span><br><span class="line">                &amp;&amp; (mLaunchFlags &amp; FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span>) &#123;</span><br><span class="line">            newTask = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">//标记4</span></span><br><span class="line">            result = setTaskFromReuseOrCreateNewTask(</span><br><span class="line">                    taskToAffiliate, preferredLaunchStackId, topStack);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mSourceRecord != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//设置与源Activity一样的Task和Stack</span></span><br><span class="line">            result = setTaskFromSourceRecord();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mInTask != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//指定了Task中启动的时候会带这里</span></span><br><span class="line">            result = setTaskFromInTask();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            setTaskToCurrentTopOrCreateNewTask();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>startActivityUnchecked方法内主要就是处理了启动模式相关的操作，设置目标Activity的Stack和Task。</p>
<h4 id="标记1：computeLaunchingTaskFlags"><a href="#标记1：computeLaunchingTaskFlags" class="headerlink" title="标记1：computeLaunchingTaskFlags"></a>标记1：computeLaunchingTaskFlags</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">computeLaunchingTaskFlags</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">//判断是在什么情况下需要自动加上FLAG_ACTIVITY_NEW_TASK标志</span></span><br><span class="line">  <span class="keyword">if</span> (mInTask == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mSourceRecord == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 表示没有源Activity的时候，就需要启动一个新的Task</span></span><br><span class="line">            <span class="keyword">if</span> ((mLaunchFlags &amp; FLAG_ACTIVITY_NEW_TASK) == <span class="number">0</span> &amp;&amp; mInTask == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"startActivity called from non-Activity context; forcing "</span> +</span><br><span class="line">                            <span class="string">"Intent.FLAG_ACTIVITY_NEW_TASK for: "</span> + mIntent);</span><br><span class="line">                mLaunchFlags |= FLAG_ACTIVITY_NEW_TASK;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mSourceRecord.launchMode == LAUNCH_SINGLE_INSTANCE) &#123;</span><br><span class="line">            <span class="comment">// 表示源Activity的启动模式为SingleInstance，这时候需要启动一个新的Task</span></span><br><span class="line">            mLaunchFlags |= FLAG_ACTIVITY_NEW_TASK;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mLaunchSingleInstance || mLaunchSingleTask) &#123;</span><br><span class="line">            <span class="comment">// 当此时的Activity的启动模式设置为SingleInstance或者是SingleTask</span></span><br><span class="line">             <span class="comment">// 需要启动一个新的Task</span></span><br><span class="line">            mLaunchFlags |= FLAG_ACTIVITY_NEW_TASK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="标记2：getReusableIntentActivity"><a href="#标记2：getReusableIntentActivity" class="headerlink" title="标记2：getReusableIntentActivity"></a>标记2：getReusableIntentActivity</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取可以复用的Task</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> ActivityRecord <span class="title">getReusableIntentActivity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//排除了standard和singleTop这两种启动模式</span></span><br><span class="line">    <span class="keyword">boolean</span> putIntoExistingTask = ((mLaunchFlags &amp; FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">            (mLaunchFlags &amp; FLAG_ACTIVITY_MULTIPLE_TASK) == <span class="number">0</span>)</span><br><span class="line">            || mLaunchSingleInstance || mLaunchSingleTask;</span><br><span class="line">    </span><br><span class="line">    putIntoExistingTask &amp;= mInTask == <span class="keyword">null</span> &amp;&amp; mStartActivity.resultTo == <span class="keyword">null</span>;</span><br><span class="line">    ActivityRecord intentActivity = <span class="keyword">null</span>;</span><br><span class="line">  	<span class="comment">//当准确知道目标Activity会具体在哪个Task内，getLaunchTaskId不会为-1</span></span><br><span class="line">    <span class="keyword">if</span> (mOptions != <span class="keyword">null</span> &amp;&amp; mOptions.getLaunchTaskId() != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> TaskRecord task = mSupervisor.anyTaskForIdLocked(mOptions.getLaunchTaskId());</span><br><span class="line">        intentActivity = task != <span class="keyword">null</span> ? task.getTopActivity() : <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (putIntoExistingTask) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mLaunchSingleInstance) &#123;</span><br><span class="line">            <span class="comment">//SingleInstance,搜索所有的stack以及从栈顶到底遍历task去寻找对应的Activity</span></span><br><span class="line">            <span class="comment">//找不到返回null</span></span><br><span class="line">            <span class="comment">//主要比较的是Intent的Action、Data、Type、Categories、Package、Component</span></span><br><span class="line">            <span class="comment">//或者是Component，根据findActivityLocked最后一个参数判断</span></span><br><span class="line">            intentActivity = mSupervisor.findActivityLocked(mIntent, mStartActivity.info,</span><br><span class="line">                   mStartActivity.isHomeActivity());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((mLaunchFlags &amp; FLAG_ACTIVITY_LAUNCH_ADJACENT) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//分屏相关</span></span><br><span class="line">            intentActivity = mSupervisor.findActivityLocked(mIntent, mStartActivity.info,</span><br><span class="line">                    !mLaunchSingleTask);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//遍历每个stack里面的Task，task.getTopActivity获取栈顶的Activity</span></span><br><span class="line">            <span class="comment">//主要比较的是这个目标Activity的Intent的ComponentName和Task的Intent的ComponentName  </span></span><br><span class="line">            <span class="comment">//以及他们的TaskAffinity，所以得到一个复用的Task，返回复用Task栈顶的ActivityRecord</span></span><br><span class="line">            intentActivity = mSupervisor.findTaskLocked(mStartActivity, mSourceDisplayId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> intentActivity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="标记3：setTaskFromIntentActivity"><a href="#标记3：setTaskFromIntentActivity" class="headerlink" title="标记3：setTaskFromIntentActivity"></a>标记3：setTaskFromIntentActivity</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setTaskFromIntentActivity</span><span class="params">(ActivityRecord intentActivity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((mLaunchFlags &amp; (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))</span><br><span class="line">                == (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK)) &#123;</span><br><span class="line">            <span class="comment">//获取重用的Task</span></span><br><span class="line">            <span class="keyword">final</span> TaskRecord task = intentActivity.getTask();</span><br><span class="line">            <span class="comment">//清除该Task内的所有Activity</span></span><br><span class="line">            task.performClearTaskLocked();</span><br><span class="line">            <span class="comment">//对Task重新赋值</span></span><br><span class="line">            mReuseTask = task;</span><br><span class="line">            mReuseTask.setIntent(mStartActivity);</span><br><span class="line"></span><br><span class="line">            mMovedOtherTask = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((mLaunchFlags &amp; FLAG_ACTIVITY_CLEAR_TOP) != <span class="number">0</span></span><br><span class="line">                || mLaunchSingleInstance || mLaunchSingleTask) &#123;</span><br><span class="line">            <span class="comment">//清除目标Activity在Task中对应位置上面的所有Activity</span></span><br><span class="line">            <span class="comment">//跟上面的处理的是一样的</span></span><br><span class="line">            ActivityRecord top = intentActivity.getTask().performClearTaskLocked(mStartActivity,</span><br><span class="line">                    mLaunchFlags);</span><br><span class="line">            <span class="keyword">if</span> (top == <span class="keyword">null</span>) &#123;</span><br><span class="line">                </span><br><span class="line">                mAddingToTask = <span class="keyword">true</span>;</span><br><span class="line">              	<span class="comment">//把目标Activity的Task设置为null，后面需重新计算该Activity需要放置的Task</span></span><br><span class="line">                mStartActivity.setTask(<span class="keyword">null</span>);</span><br><span class="line">                </span><br><span class="line">                mSourceRecord = intentActivity;</span><br><span class="line">                <span class="keyword">final</span> TaskRecord task = mSourceRecord.getTask();</span><br><span class="line">                <span class="keyword">if</span> (task != <span class="keyword">null</span> &amp;&amp; task.getStack() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    </span><br><span class="line">                    mTargetStack = computeStackFocus(mSourceRecord, <span class="keyword">false</span> <span class="comment">/* newTask */</span>,</span><br><span class="line">                            <span class="keyword">null</span> <span class="comment">/* bounds */</span>, mLaunchFlags, mOptions);</span><br><span class="line">                    mTargetStack.addTask(task,</span><br><span class="line">                            !mLaunchTaskBehind <span class="comment">/* toTop */</span>, <span class="string">"startActivityUnchecked"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mStartActivity.realActivity.equals(intentActivity.getTask().realActivity)) &#123;</span><br><span class="line">            <span class="comment">//如果重用的Activity和目标的Activity一样，并且是SingleTop的情况下</span></span><br><span class="line">            <span class="keyword">if</span> (((mLaunchFlags &amp; FLAG_ACTIVITY_SINGLE_TOP) != <span class="number">0</span> || mLaunchSingleTop)</span><br><span class="line">                    &amp;&amp; intentActivity.realActivity.equals(mStartActivity.realActivity)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (intentActivity.frontOfTask) &#123;</span><br><span class="line">                    intentActivity.getTask().setIntent(mStartActivity);</span><br><span class="line">                &#125;</span><br><span class="line">              	<span class="comment">//onNewIntent</span></span><br><span class="line">                deliverNewIntent(intentActivity);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!intentActivity.getTask().isSameIntentFilter(mStartActivity)) &#123;</span><br><span class="line">                <span class="comment">//Task的Intent和目标Activity的Intent不同</span></span><br><span class="line">                <span class="comment">//表示不能复用Activity</span></span><br><span class="line">                mAddingToTask = <span class="keyword">true</span>;</span><br><span class="line">                mSourceRecord = intentActivity;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((mLaunchFlags &amp; FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) == <span class="number">0</span>) &#123;</span><br><span class="line">            </span><br><span class="line">            mAddingToTask = <span class="keyword">true</span>;</span><br><span class="line">            mSourceRecord = intentActivity;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!intentActivity.getTask().rootWasReset) &#123;</span><br><span class="line">            </span><br><span class="line">            intentActivity.getTask().setIntent(mStartActivity);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="标记4：setTaskFromReuseOrCreateNewTask"><a href="#标记4：setTaskFromReuseOrCreateNewTask" class="headerlink" title="标记4：setTaskFromReuseOrCreateNewTask"></a>标记4：setTaskFromReuseOrCreateNewTask</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">setTaskFromReuseOrCreateNewTask</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            TaskRecord taskToAffiliate, <span class="keyword">int</span> preferredLaunchStackId, ActivityStack topStack)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//主要是获取或创建ActivityStack，具体操作如下：</span></span><br><span class="line">    <span class="comment">//1.如果mReuseTask不为空则直接使用该Task对应的ActivityStack</span></span><br><span class="line">    <span class="comment">//注：mReuseTask在清除Task所有Activity的时候进行了赋值以及指定了mInTask的时候</span></span><br><span class="line">    <span class="comment">//2.根据目标Activity的类型获取对应的ActivityStack</span></span><br><span class="line">    <span class="comment">//3.前台ActivityStack不为空，并且该Stack的顶部的Task等于目标Activity的Task，则返回前台ActivityStack</span></span><br><span class="line">    <span class="comment">//4.判断目标Activity对应的Task所在的ActivityStack是否存在</span></span><br><span class="line">    <span class="comment">//5.遍历当前屏幕下的所有ActivityStack，如果是动态创建的Stack，则返回</span></span><br><span class="line">    <span class="comment">//6.最终创建一个ActivityStack</span></span><br><span class="line">    mTargetStack = computeStackFocus(</span><br><span class="line">                mStartActivity, <span class="keyword">true</span>, mLaunchBounds, mLaunchFlags, mOptions)</span><br><span class="line">    <span class="keyword">if</span> (mReuseTask == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//通过ActivityStack新建TaskRecord</span></span><br><span class="line">        <span class="comment">//加入到TaskHistory</span></span><br><span class="line">        <span class="keyword">final</span> TaskRecord task = mTargetStack.createTaskRecord(</span><br><span class="line">                    mSupervisor.getNextTaskIdForUserLocked(mStartActivity.userId),</span><br><span class="line">                    mNewTaskInfo != <span class="keyword">null</span> ? mNewTaskInfo : mStartActivity.info,</span><br><span class="line">                    mNewTaskIntent != <span class="keyword">null</span> ? mNewTaskIntent : mIntent, mVoiceSession,</span><br><span class="line">                    mVoiceInteractor, !mLaunchTaskBehind <span class="comment">/* toTop */</span>, mStartActivity.mActivityType);</span><br><span class="line">        <span class="comment">//将目标Activity添加到该Task顶部</span></span><br><span class="line">        addOrReparentStartingActivity(task, <span class="string">"setTaskFromReuseOrCreateNewTask - mReuseTask"</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        addOrReparentStartingActivity(mReuseTask, <span class="string">"setTaskFromReuseOrCreateNewTask"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (mDoResume) &#123;</span><br><span class="line">        <span class="comment">//移动到前台</span></span><br><span class="line">        mTargetStack.moveToFront(<span class="string">"reuseOrNewTask"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
            </div>
          

    
      <footer class="post-footer">
		
		<div class="post-tags">
		  
			<a href="/uuluu.github.io/tags/源码/">源码</a>
		  
		</div>
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/uuluu.github.io/2019/08/02/捋不清的源码-Activity启动流程相关/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">捋不清的源码---Activity启动流程相关</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/uuluu.github.io/2019/04/24/my-site/">
        <span class="next-text nav-default">Android事件分发学习记录</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2014 -
    
    2019
    <span class="footer-author">uu.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/uuluu.github.io/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/uuluu.github.io/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/uuluu.github.io/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
